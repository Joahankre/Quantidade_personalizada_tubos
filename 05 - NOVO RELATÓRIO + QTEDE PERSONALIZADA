Imports System.Windows.Forms
Imports Inventor
Imports System.Text
Imports System.IO
Imports System.Linq

Sub Main()

    Dim oApp As Inventor.Application = ThisApplication
    Dim oDoc As Document = oApp.ActiveDocument

    If oDoc.DocumentType <> DocumentTypeEnum.kAssemblyDocumentObject Then
        MessageBox.Show("Execute este script em um documento de montagem (.iam).", "Documento invÃ¡lido", MessageBoxButtons.OK, MessageBoxIcon.Warning)
        Return
    End If

    ' Nome da propriedade personalizada
    Dim oBOMQTY As String = "QTDE PERSONALIZADA"

    ' ===================== CONFIGURA BOM =====================
    Dim asmDoc As AssemblyDocument = oDoc
    Dim bom As BOM = asmDoc.ComponentDefinition.BOM
    bom.StructuredViewEnabled = True

    Dim modelDataView As BOMView = Nothing
    For Each view As BOMView In bom.BOMViews
        If View.ViewType = BOMViewTypeEnum.kModelDataBOMViewType Then
            modelDataView = View
            Exit For
        End If
    Next

    If modelDataView Is Nothing Then
        MessageBox.Show("BOM View do tipo Model Data nÃ£o encontrada.", "Erro", MessageBoxButtons.OK, MessageBoxIcon.Error)
        Return
    End If

    ' ===================== COLETA FRAME MONTAGENS =====================
    Dim frameRows As New List(Of BOMRow)
    For Each row As BOMRow In modelDataView.BOMRows
        ColetarMontagensFrameRecursivo(Row, frameRows)
    Next

    If frameRows.Count = 0 Then
        MessageBox.Show("Nenhuma montagem iniciando com 'Frame' foi encontrada.", "InformaÃ§Ã£o", MessageBoxButtons.OK, MessageBoxIcon.Information)
        Return
    End If

    ' ===================== MAPEAR QUANTIDADES (Part Number + Massa) =====================
    Dim partCount As New Dictionary(Of String, Integer)(StringComparer.InvariantCultureIgnoreCase)

    For Each row As BOMRow In frameRows
        ContarPartesPorMassa(Row, partCount)
    Next

    ' ===================== ATUALIZA PROPRIEDADE PERSONALIZADA =====================
    AtualizarPropriedadesPersonalizadas(oBOMQTY, partCount)

    ' ===================== GERA RELATÃ“RIO =====================
    Dim sb As New StringBuilder()
    sb.AppendLine("ðŸ“‹ RelatÃ³rio das Montagens 'Frame...' e Subitens")
    sb.AppendLine(New String(" "c, nivel * 4) &
              String.Format("{0,-8}{1,-30}{2,-55}{3,-15:F3}{4,-10}", item, pn, desc, massa, qtde))

    For Each row As BOMRow In frameRows
        AdicionarLinhaComMassa(Row, sb, 0, partCount)
    Next

    ' ===================== EXIBE RESULTADO =====================
    Dim form As New Form With {
        .Text = "Resumo das Montagens 'Frame' + QTDE PERSONALIZADA",
        .Width = 900,
        .Height = 650,
        .StartPosition = FormStartPosition.CenterScreen
    }

    Dim textBox As New System.Windows.Forms.TextBox With {
        .Multiline = True,
        .ReadOnly = True,
        .ScrollBars = ScrollBars.Both,
        .Dock = DockStyle.Fill,
        .Text = sb.ToString()
    }

    form.Controls.Add(textBox)

    Dim btnClose As New Button With {
        .Text = "Fechar",
        .Dock = DockStyle.Bottom,
        .Height = 35
    }
    AddHandler btnClose.Click, Sub(sender, e) form.Close()
    form.Controls.Add(btnClose)

    form.ShowDialog()

End Sub

' ================================================================
' Coleta montagens "Frame..." e seus subitens (ignorando Skeleton)
Sub ColetarMontagensFrameRecursivo(row As BOMRow, lista As List(Of BOMRow))
    Try
        If row.ComponentDefinitions.Count > 0 Then
            Dim compDef As ComponentDefinition = row.ComponentDefinitions.Item(1)
            Dim doc As Document = compDef.Document

            Dim partNumber As String = ""
            Try
                partNumber = doc.PropertySets.Item("Design Tracking Properties").Item("Part Number").Value.ToString()
            Catch
            End Try

            ' Adiciona se for montagem Frame...
            If partNumber.StartsWith("Frame", StringComparison.InvariantCultureIgnoreCase) Then
                lista.Add(row)
            End If

            ' Ignora esboÃ§os Skeleton
            If partNumber.StartsWith("Skeleton", StringComparison.InvariantCultureIgnoreCase) Then
                Return
            End If

            ' Percorre filhos
            If row.ChildRows IsNot Nothing Then
                For Each child As BOMRow In row.ChildRows
                    ColetarMontagensFrameRecursivo(child, lista)
                Next
            End If
        End If
    Catch
    End Try
End Sub

' ================================================================
' Contabiliza repetiÃ§Ãµes com base em Part Number + Massa + Quantidade real da BOM
Sub ContarPartesPorMassa(row As BOMRow, dict As Dictionary(Of String, Integer))
    Try
        If row.ComponentDefinitions.Count > 0 Then
            Dim compDef As ComponentDefinition = row.ComponentDefinitions.Item(1)
            Dim doc As Document = compDef.Document

            Dim partNumber As String = ""
            Dim massa As Double = 0.0
            Dim quantidade As Integer = row.TotalQuantity

            Try
                partNumber = doc.PropertySets.Item("Design Tracking Properties").Item("Part Number").Value.ToString()
            Catch
                partNumber = "(sem PN)"
            End Try

            Try
                massa = doc.ComponentDefinition.MassProperties.Mass
            Catch
            End Try

            Dim key As String = partNumber & "|" & Math.Round(massa, 5).ToString()

            If dict.ContainsKey(key) Then
                dict(key) += quantidade
            Else
                dict.Add(key, quantidade)
            End If
        End If

        ' Percorre filhos
        If row.ChildRows IsNot Nothing Then
            For Each child As BOMRow In row.ChildRows
                ContarPartesPorMassa(child, dict)
            Next
        End If
    Catch
    End Try
End Sub

' ================================================================
' Cria/atualiza propriedade personalizada "QTDE PERSONALIZADA"
Sub AtualizarPropriedadesPersonalizadas(oBOMQTY As String, dict As Dictionary(Of String, Integer))
    For Each kvp As KeyValuePair(Of String, Integer) In dict
        Dim keyParts() As String = kvp.Key.Split("|"c)
        Dim partNumber As String = keyParts(0)
        Dim massaKey As Double = CDbl(keyParts(1))

        For Each doc As Document In ThisApplication.Documents
            Try
                Dim pn As String = ""
                Try
                    pn = doc.PropertySets.Item("Design Tracking Properties").Item("Part Number").Value.ToString()
                Catch
                End Try

                If pn.Equals(partNumber, StringComparison.InvariantCultureIgnoreCase) Then
                    Dim massaDoc As Double = 0.0
                    Try
                        massaDoc = doc.ComponentDefinition.MassProperties.Mass
                    Catch
                    End Try

                    If Math.Abs(massaDoc - massaKey) < 0.00001 Then
                        Dim customProps As PropertySet = Nothing
                        Try
                            customProps = doc.PropertySets.Item("Inventor User Defined Properties")
                        Catch
                            Continue For
                        End Try

                        If customProps.Contains(oBOMQTY) Then
                            customProps.Item(oBOMQTY).Value = kvp.Value
                        Else
                            customProps.Add(kvp.Value, oBOMQTY)
                        End If

                        doc.Update()
                    End If
                End If
            Catch
            End Try
        Next
    Next
End Sub

' ================================================================
' Exibe as linhas do Frame com massa e quantidade
' ================================================================
' Exibe as linhas do Frame com massa e quantidade
' e grava a quantidade como propriedade personalizada "QTDE PERSONALIZADA"
Sub AdicionarLinhaComMassa(row As BOMRow, sb As StringBuilder, nivel As Integer, dict As Dictionary(Of String, Integer))
    Try
        Dim item As String = row.ItemNumber
        Dim pn As String = ""
        Dim desc As String = ""
        Dim massa As Double = 0.0
        Dim oBOMQTY As String = "QTDE PERSONALIZADA"

        If row.ComponentDefinitions.Count > 0 Then
            Dim compDef As ComponentDefinition = row.ComponentDefinitions.Item(1)
            Dim doc As Document = compDef.Document

            Try
                pn = doc.PropertySets.Item("Design Tracking Properties").Item("Part Number").Value.ToString()
            Catch
                pn = "(sem PN)"
            End Try

            Try
                desc = doc.PropertySets.Item("Design Tracking Properties").Item("Description").Value.ToString()
            Catch
                desc = "(sem descriÃ§Ã£o)"
            End Try

            Try
                massa = doc.ComponentDefinition.MassProperties.Mass
            Catch
            End Try
        End If

        If pn.StartsWith("Skeleton", StringComparison.InvariantCultureIgnoreCase) Then
            Return
        End If

        Dim key As String = pn & "|" & Math.Round(massa, 5).ToString()
        Dim qtde As Integer = If(dict.ContainsKey(key), dict(key), 1)

        ' ======= ATUALIZA OU CRIA A PROPRIEDADE PERSONALIZADA =======
        Try
            Dim oDoc As Document = row.ComponentDefinitions.Item(1).Document
            Dim customProps As PropertySet = oDoc.PropertySets.Item("Inventor User Defined Properties")
            Try
                Dim prop As [Property] = Nothing
                Try
                    prop = customProps.Item(oBOMQTY)
                    prop.Value = qtde
                Catch
                    customProps.Add(qtde, oBOMQTY)
                End Try
                oDoc.Update()
            Catch
            End Try
        Catch
        End Try

        ' ======= LINHA DO RELATÃ“RIO =======
        sb.AppendLine(New String(" "c, nivel * 4) &
                      String.Format("{0,-8}{1,-30}{2,-55}{3,-15:F3}{4,-10}", item, pn, desc, massa, qtde))

        ' ======= RECURSIVIDADE =======
        If row.ChildRows IsNot Nothing Then
            For Each child As BOMRow In row.ChildRows
                AdicionarLinhaComMassa(child, sb, nivel + 1, dict)
            Next
        End If

    Catch
    End Try
End Sub
