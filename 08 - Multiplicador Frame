Imports System.Windows.Forms
Imports Inventor
Imports System.Text
Imports System.IO
Imports System.Linq

' ==============================================================
' iLogic Integrado: Multiplicador Simples + Multiplicador Frame
' Unificado com um único InputBox e ProgressBar otimizada
' ==============================================================

Sub Main()
    ' =========================
    ' VERIFICA DOCUMENTO
    ' =========================
    Dim oDoc As Document = ThisApplication.ActiveDocument

    If oDoc.DocumentType <> kAssemblyDocumentObject Then
        MessageBox.Show("Esta regra só pode ser executada em um arquivo de montagem - saindo da regra...", "iLogic")
        Return
    End If

    ' =========================
    ' SOLICITA MULTIPLICADOR (UMA ÚNICA VEZ)
    ' =========================
    Dim multiplicador As Integer = SolicitarMultiplicador()

    If multiplicador < 1 Then
        Return
    End If

    ' Nome da propriedade personalizada
    Dim oBOMQTY As String = "QTDE PERSONALIZADA"

    ' =========================
    ' EXECUTA OS DOIS PROCESSOS
    ' =========================
    ExecutarMultiplicadorSimples(oDoc, oBOMQTY, multiplicador)
    ExecutarMultiplicadorFrame(oDoc, oBOMQTY, multiplicador)

    MessageBox.Show($"Processo concluído com sucesso!{vbCrLf}Multiplicador aplicado: {multiplicador}", "Concluído", MessageBoxButtons.OK, MessageBoxIcon.Information)
    GerarRelatorioQtdePersonalizada(oDoc, oBOMQTY)
End Sub

' Solicita o multiplicador do usuário com validação
Function SolicitarMultiplicador() As Integer
    Dim input As String = InputBox("Digite a quantidade de vezes que este projeto será produzido:", "Multiplicador de Projeto", "1")
    
    If Not IsNumeric(input) Then
        MessageBox.Show("Valor inválido. Use apenas números.", "Erro")
        Return -1
    End If

    Dim multiplicador As Integer = CInt(input)

    If multiplicador < 1 Then
        MessageBox.Show("O multiplicador deve ser maior ou igual a 1.", "Erro")
        Return -1
    End If

    Return multiplicador
End Function

' ==============================================================
' SCRIPT 1 - MULTIPLICADOR SIMPLES
' ==============================================================

Sub ExecutarMultiplicadorSimples(oDoc As Document, oBOMQTY As String, multiplicador As Integer)
    Dim refDocs As DocumentsEnumerator = oDoc.AllReferencedDocuments
    Dim oProgressBar As Inventor.ProgressBar = CriarProgressBar(refDocs.Count, "Atualizando propriedades: Etapa ")

    For Each docFile As Document In refDocs
        AtualizarPropriedadePersonalizada(docFile, oBOMQTY, multiplicador)
        oProgressBar.UpdateProgress()
    Next

    AtualizarPropriedadePersonalizada(oDoc, oBOMQTY, multiplicador)
    oProgressBar.Close()
End Sub

' Atualiza a propriedade personalizada para o documento fornecido
Sub AtualizarPropriedadePersonalizada(doc As Document, oBOMQTY As String, multiplicador As Integer)
    Try
        Dim qtdeTotal As Integer = CalcularQtdeTotal(doc, multiplicador)
        iProperties.Value(doc.DisplayName, "Custom", oBOMQTY) = qtdeTotal
    Catch ex As Exception
        iProperties.Value(doc.DisplayName, "Custom", oBOMQTY) = multiplicador
    End Try
End Sub

' Calcula a quantidade total de uma referência multiplicada
Function CalcularQtdeTotal(doc As Document, multiplicador As Integer) As Integer
    Dim assemblyDef As AssemblyComponentDefinition = doc.ComponentDefinition
    Return assemblyDef.Occurrences.AllReferencedOccurrences(doc).Count * multiplicador
End Function

' Cria e retorna a barra de progresso
Function CriarProgressBar(oProgressSteps As Integer, mensagemBase As String) As Inventor.ProgressBar
    Dim oProgressBar As Inventor.ProgressBar = ThisApplication.CreateProgressBar(False, oProgressSteps, "Quantidade de Itens e Submontagens")
    oProgressBar.Message = mensagemBase & "0 de " & oProgressSteps
    oProgressBar.UpdateProgress
    Return oProgressBar
End Function

' ==============================================================
' SCRIPT 2 - MULTIPLICADOR FRAME (somente filhos dos frames)
' ==============================================================

Sub ExecutarMultiplicadorFrame(oDoc As Document, oBOMQTY As String, multiplicadorGlobal As Integer)
    Dim asmDoc As AssemblyDocument = oDoc
    Dim bom As BOM = asmDoc.ComponentDefinition.BOM
    bom.StructuredViewEnabled = True

    Dim modelDataView As BOMView = ObterModelDataBOMView(bom)

    If modelDataView Is Nothing Then
        MessageBox.Show("BOM View do tipo Model Data não encontrada.", "Erro", MessageBoxButtons.OK, MessageBoxIcon.Error)
        Return
    End If

    ' Coleta todas as montagens "Frame"
    Dim frameRows As List(Of BOMRow) = ObterMontagensFrame(modelDataView)

    If frameRows.Count = 0 Then Return

    ' Barra de progresso
    Dim oProgressBar As Inventor.ProgressBar = CriarProgressBar(frameRows.Count, "Atualizando montagens Frame individualmente...")

    ' Processa cada Frame separadamente
    For Each frameRow As BOMRow In frameRows
        ProcessarFrame(frameRow, oBOMQTY, multiplicadorGlobal, oProgressBar)
    Next

    oProgressBar.Close()
End Sub

' Obtem a visão de Model Data do BOM
Function ObterModelDataBOMView(bom As BOM) As BOMView
    Return bom.BOMViews.FirstOrDefault(Function(v) v.ViewType = BOMViewTypeEnum.kModelDataBOMViewType)
End Function

' Coleta as montagens Frame dentro de uma BOMView
Function ObterMontagensFrame(modelDataView As BOMView) As List(Of BOMRow)
    Dim frameRows As New List(Of BOMRow)

    For Each row As BOMRow In modelDataView.BOMRows
        ColetarMontagensFrameRecursivo(Row, frameRows)
    Next

    Return frameRows
End Function

' Processa um único Frame
Sub ProcessarFrame(frameRow As BOMRow, oBOMQTY As String, multiplicadorGlobal As Integer, oProgressBar As Inventor.ProgressBar)
    Try
        Dim partCount As Dictionary(Of String, Integer) = ContarPartesPorMassa(frameRow)
        Dim frameMultiplicador As Integer = ObterMultiplicadorFrame(frameRow)
        Dim partCountMultiplicado As Dictionary(Of String, Integer) = AplicarMultiplicador(partCount, multiplicadorGlobal, frameMultiplicador)
        AtualizarPropriedadesPersonalizadasFilhos(oBOMQTY, partCountMultiplicado, oProgressBar)
    Catch ex As Exception
        ' Ignora erros individuais
    End Try
End Sub

' Obtém o multiplicador do frame
Function ObterMultiplicadorFrame(frameRow As BOMRow) As Integer
    Try
        Dim customProps As PropertySet = frameRow.ComponentDefinitions.Item(1).Document.PropertySets.Item("Inventor User Defined Properties")
        Return CInt(customProps.Item("QTDE PERSONALIZADA").Value)
    Catch
        Return 1
    End Try
End Function

' Contar as partes de um frame por massa
Function ContarPartesPorMassa(frameRow As BOMRow) As Dictionary(Of String, Integer)
    Dim partCount As New Dictionary(Of String, Integer)(StringComparer.InvariantCultureIgnoreCase)
    If frameRow.ChildRows IsNot Nothing Then
        For Each child As BOMRow In frameRow.ChildRows
            ContarPartesPorMassaRecursivo(child, partCount)
        Next
    End If
    Return partCount
End Function

' Aplica o multiplicador do frame e o global
Function AplicarMultiplicador(partCount As Dictionary(Of String, Integer), multiplicadorGlobal As Integer, frameMultiplicador As Integer) As Dictionary(Of String, Integer)
    Dim partCountMultiplicado As New Dictionary(Of String, Integer)(StringComparer.InvariantCultureIgnoreCase)

    For Each kvp As KeyValuePair(Of String, Integer) In partCount
        partCountMultiplicado.Add(kvp.Key, kvp.Value * frameMultiplicador * multiplicadorGlobal)
    Next

    Return partCountMultiplicado
End Function

' Atualiza as propriedades personalizadas de todos os filhos de frame
Sub AtualizarPropriedadesPersonalizadasFilhos(oBOMQTY As String, dict As Dictionary(Of String, Integer), oProgressBar As Inventor.ProgressBar)
    Dim oProgressStep As Integer = 0
    For Each kvp As KeyValuePair(Of String, Integer) In dict
        AtualizarPropriedadeFilho(kvp, oBOMQTY)
        oProgressStep += 1
        oProgressBar.Message = $"Atualizando filhos de Frames: {oProgressStep} de {dict.Count}"
        oProgressBar.UpdateProgress()
    Next
End Sub


    ' Atualiza uma propriedade personalizada de um filho
    Sub AtualizarPropriedadeFilho(kvp As KeyValuePair(Of String, Integer), oBOMQTY As String)
        Dim keyParts() As String = kvp.Key.Split("|"c)
        Dim partNumber As String = keyParts(0)
        Dim massaKey As Double = CDbl(keyParts(1))

        ' Atualiza SOMENTE partes (não montagens Frame)
        For Each doc As Document In ThisApplication.Documents
            Try
                ' Ignorar montagens Frame
                If doc.DocumentType = DocumentTypeEnum.kAssemblyDocumentObject Then Continue For

                Dim pn As String = ""
                Try
                    pn = doc.PropertySets.Item("Design Tracking Properties").Item("Part Number").Value.ToString()
                Catch
                End Try

                If pn.Equals(partNumber, StringComparison.InvariantCultureIgnoreCase) Then
                    Dim massaDoc As Double = 0.0
                    Try
                        massaDoc = doc.ComponentDefinition.MassProperties.Mass
                    Catch
                    End Try

                    If Math.Abs(massaDoc - massaKey) < 0.00001 Then
                        Dim customProps As PropertySet = doc.PropertySets.Item("Inventor User Defined Properties")
                        Try
                            customProps.Item(oBOMQTY).Value = kvp.Value
                        Catch
                            customProps.Add(kvp.Value, oBOMQTY)
                        End Try
                        doc.Update()
                    End If
                End If
            Catch
            End Try
        Next
    End Sub

' ==============================================================
' Funções auxiliares para Coleta e Contagem Recursiva
' ==============================================================

' Coleta montagens Frame de forma recursiva
Sub ColetarMontagensFrameRecursivo(row As BOMRow, lista As List(Of BOMRow))
    Try
        If row.ComponentDefinitions.Count > 0 Then
            Dim compDef As ComponentDefinition = row.ComponentDefinitions.Item(1)
            Dim doc As Document = compDef.Document

            Dim partNumber As String = ""
            Try
                partNumber = doc.PropertySets.Item("Design Tracking Properties").Item("Part Number").Value.ToString()
            Catch
            End Try

            If partNumber.StartsWith("Frame", StringComparison.InvariantCultureIgnoreCase) Then
                lista.Add(row)
            End If

            If Not partNumber.StartsWith("Skeleton", StringComparison.InvariantCultureIgnoreCase) Then
                If row.ChildRows IsNot Nothing Then
                    For Each child As BOMRow In row.ChildRows
                        ColetarMontagensFrameRecursivo(child, lista)
                    Next
                End If
            End If
        End If
    Catch
    End Try
End Sub

' Contar partes por massa dentro de uma linha de BOM
Sub ContarPartesPorMassaRecursivo(row As BOMRow, dict As Dictionary(Of String, Integer))
    Try
        If row.ComponentDefinitions.Count > 0 Then
            Dim compDef As ComponentDefinition = row.ComponentDefinitions.Item(1)
            Dim doc As Document = compDef.Document

            Dim partNumber As String = "(sem PN)"
            Dim massa As Double = 0.0

            Try
                partNumber = doc.PropertySets.Item("Design Tracking Properties").Item("Part Number").Value.ToString()
            Catch
            End Try

            Try
                massa = doc.ComponentDefinition.MassProperties.Mass
            Catch
            End Try

            Dim key As String = partNumber & "|" & Math.Round(massa, 5).ToString()

            If dict.ContainsKey(key) Then
                dict(key) += 1
            Else
                dict.Add(key, 1)
            End If
        End If

        If row.ChildRows IsNot Nothing Then
            For Each child As BOMRow In row.ChildRows
                ContarPartesPorMassaRecursivo(child, dict)
            Next
        End If
    Catch
    End Try
End Sub

' ==============================================================
' GERA RELATÓRIO DE QTDE PERSONALIZADA
' ==============================================================

Sub GerarRelatorioQtdePersonalizada(oDoc As Document, oBOMQTY As String)
    Try
        Dim sb As New StringBuilder()
        sb.AppendLine("===================================================")
        sb.AppendLine("RELATÓRIO DE QTDE PERSONALIZADA - " & Now.ToString("dd/MM/yyyy HH:mm:ss"))
        sb.AppendLine("Montagem: " & oDoc.DisplayName)
        sb.AppendLine("===================================================")
        sb.AppendLine("")
        sb.AppendLine(String.Format("{0,-50}{1,15}", "ARQUIVO / PART NUMBER", "QTDE PERSONALIZADA"))
        sb.AppendLine(String.Format("{0,-50}{1,15}", "----------------------------------------------", "------------------"))

        ' Percorre todos os documentos abertos e lista os que têm a propriedade personalizada
        For Each doc As Document In ThisApplication.Documents
            Try
                Dim customProps As PropertySet = doc.PropertySets.Item("Inventor User Defined Properties")
                Dim valor As Object = Nothing

                Try
                    valor = customProps.Item(oBOMQTY).Value
                Catch
                    valor = Nothing
                End Try

                If valor IsNot Nothing Then
                    Dim pn As String = ""
                    Try
                        pn = doc.PropertySets.Item("Design Tracking Properties").Item("Part Number").Value.ToString()
                    Catch
                        pn = "(sem PN)"
                    End Try

                    Dim linha As String = String.Format("{0,-50}{1,15}", pn, valor.ToString())
                    sb.AppendLine(linha)
                End If
            Catch
            End Try
        Next

        sb.AppendLine("")
        sb.AppendLine("===================================================")

        ' Caminho do relatório
        Dim pastaRelatorio As String = System.IO.Path.GetDirectoryName(oDoc.FullFileName)
        Dim arquivoRelatorio As String = System.IO.Path.Combine(pastaRelatorio, "Relatorio_QTDE_PERSONALIZADA.txt")

        System.IO.File.WriteAllText(arquivoRelatorio, sb.ToString(), Encoding.UTF8)

        MessageBox.Show("Relatório gerado com sucesso!" & vbCrLf & arquivoRelatorio, "Relatório", MessageBoxButtons.OK, MessageBoxIcon.Information)

    Catch ex As Exception
        MessageBox.Show("Erro ao gerar relatório: " & ex.Message, "Erro", MessageBoxButtons.OK, MessageBoxIcon.Error)
    End Try
End Sub
