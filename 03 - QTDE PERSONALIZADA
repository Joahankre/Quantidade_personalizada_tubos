Imports Inventor
Imports System.Text
Imports System.Collections.Generic

' ============================================================== 
' iLogic Integrado: Executa dois scripts sequenciais de forma silenciosa
' ==============================================================

Sub Main()
    ' Defina aqui o multiplicador que deseja aplicar
    Dim multiplicador As Integer = 2  ' <-- Alterar conforme necessidade

    ' Executa o Multiplicador Simples
    ExecutarMultiplicadorSimples(multiplicador)

    ' Executa o Multiplicador Frame
    ExecutarMultiplicadorFrame(multiplicador)
End Sub

' ==========================================================
' Script 1: Multiplicador Simples (Silencioso)
' ==========================================================
Sub ExecutarMultiplicadorSimples(multiplicador As Integer)
    Dim oDoc As Document = ThisApplication.ActiveDocument
    If oDoc.DocumentType <> kAssemblyDocumentObject Then Return

    Dim oBOMQTY As String = "QTDE PERSONALIZADA"
    AtualizarQuantidadePersonalizada(oBOMQTY, multiplicador)
End Sub

Sub AtualizarQuantidadePersonalizada(oBOMQTY As String, multiplicador As Integer)
    Dim openDoc As Document = ThisDoc.Document
    Dim refDocs As DocumentsEnumerator = openDoc.AllReferencedDocuments

    For Each docFile As Document In refDocs
        If docFile.IsModifiable = True Then
            Try
                Dim assemblyDoc As AssemblyDocument = openDoc
                Dim assemblyDef As AssemblyComponentDefinition = assemblyDoc.ComponentDefinition
                Dim partQty As Object = assemblyDef.Occurrences.AllReferencedOccurrences(docFile)
                Dim qtdeTotal As Integer = partQty.Count * multiplicador

                Try
                    iProperties.Value(docFile.DisplayName, "Custom", oBOMQTY) = qtdeTotal
                Catch
                    iProperties.Value(docFile.DisplayName, "Custom", oBOMQTY) = qtdeTotal
                End Try
            Catch
            End Try
        End If
    Next

    Try
        iProperties.Value("Custom", oBOMQTY) = multiplicador
    Catch
        iProperties.Value("Custom", oBOMQTY) = multiplicador
    End Try
    iLogicVb.UpdateWhenDone = True
End Sub

' ==========================================================
' Script 2: Multiplicador Frame (Silencioso)
' ==========================================================
Sub ExecutarMultiplicadorFrame(multiplicador As Integer)
    Dim oDoc As Document = ThisApplication.ActiveDocument
    If oDoc.DocumentType <> DocumentTypeEnum.kAssemblyDocumentObject Then Return

    Dim oBOMQTY As String = "QTDE PERSONALIZADA"
    Dim asmDoc As AssemblyDocument = oDoc
    Dim bom As BOM = asmDoc.ComponentDefinition.BOM
    bom.StructuredViewEnabled = True

    Dim modelDataView As BOMView = Nothing
    For Each view As BOMView In bom.BOMViews
        If view.ViewType = BOMViewTypeEnum.kModelDataBOMViewType Then
            modelDataView = view
            Exit For
        End If
    Next
    If modelDataView Is Nothing Then Return

    ' Coleta montagens Frame
    Dim frameRows As New List(Of BOMRow)
    For Each row As BOMRow In modelDataView.BOMRows
        ColetarMontagensFrameRecursivo(row, frameRows)
    Next
    If frameRows.Count = 0 Then Return

    ' Conta partes
    Dim partCount As New Dictionary(Of String, Integer)(StringComparer.InvariantCultureIgnoreCase)
    For Each row As BOMRow In frameRows
        ContarPartesPorMassa(row, partCount)
    Next

    ' Aplica multiplicador
    Dim partCountMultiplicado As New Dictionary(Of String, Integer)(StringComparer.InvariantCultureIgnoreCase)
    For Each kvp As KeyValuePair(Of String, Integer) In partCount
        partCountMultiplicado.Add(kvp.Key, kvp.Value * multiplicador)
    Next

    ' Atualiza propriedades
    AtualizarPropriedadesPersonalizadas(oBOMQTY, partCountMultiplicado)
End Sub

' ================= Funções de suporte =================
Sub ColetarMontagensFrameRecursivo(row As BOMRow, lista As List(Of BOMRow))
    Try
        If row.ComponentDefinitions.Count > 0 Then
            Dim compDef As ComponentDefinition = row.ComponentDefinitions.Item(1)
            Dim doc As Document = compDef.Document
            Dim partNumber As String = ""
            Try
                partNumber = doc.PropertySets.Item("Design Tracking Properties").Item("Part Number").Value.ToString()
            Catch
            End Try

            If partNumber.StartsWith("Frame", StringComparison.InvariantCultureIgnoreCase) Then
                lista.Add(row)
            End If
            If partNumber.StartsWith("Skeleton", StringComparison.InvariantCultureIgnoreCase) Then Return

            If row.ChildRows IsNot Nothing Then
                For Each child As BOMRow In row.ChildRows
                    ColetarMontagensFrameRecursivo(child, lista)
                Next
            End If
        End If
    Catch
    End Try
End Sub

Sub ContarPartesPorMassa(row As BOMRow, dict As Dictionary(Of String, Integer))
    Try
        If row.ComponentDefinitions.Count > 0 Then
            Dim compDef As ComponentDefinition = row.ComponentDefinitions.Item(1)
            Dim doc As Document = compDef.Document
            Dim partNumber As String = "(sem PN)"
            Dim massa As Double = 0.0
            Try partNumber = doc.PropertySets.Item("Design Tracking Properties").Item("Part Number").Value.ToString() Catch
            End Try
            Try massa = doc.ComponentDefinition.MassProperties.Mass Catch
            End Try
            Dim key As String = partNumber & "|" & Math.Round(massa, 5).ToString()
            If dict.ContainsKey(key) Then dict(key) += 1 Else dict.Add(key, 1)
        End If
        If row.ChildRows IsNot Nothing Then
            For Each child As BOMRow In row.ChildRows
                ContarPartesPorMassa(child, dict)
            Next
        End If
    Catch
    End Try
End Sub

Sub AtualizarPropriedadesPersonalizadas(oBOMQTY As String, dict As Dictionary(Of String, Integer))
    For Each kvp As KeyValuePair(Of String, Integer) In dict
        Dim keyParts() As String = kvp.Key.Split("|"c)
        Dim partNumber As String = keyParts(0)
        Dim massaKey As Double = CDbl(keyParts(1))

        For Each doc As Document In ThisApplication.Documents
            Try
                Dim pn As String = ""
                Try pn = doc.PropertySets.Item("Design Tracking Properties").Item("Part Number").Value.ToString() Catch
                End Try

                If pn.Equals(partNumber, StringComparison.InvariantCultureIgnoreCase) Then
                    Dim massaDoc As Double = 0.0
                    Try massaDoc = doc.ComponentDefinition.MassProperties.Mass Catch
                    End Try

                    If Math.Abs(massaDoc - massaKey) < 0.00001 Then
                        Dim customProps As PropertySet = Nothing
                        Try customProps = doc.PropertySets.Item("Inventor User Defined Properties") Catch Continue For
                        End Try

                        Try
                            Dim prop As [Property] = Nothing
                            Try prop = customProps.Item(oBOMQTY) : prop.Value = kvp.Value Catch customProps.Add(kvp.Value, oBOMQTY) End Try
                            doc.Update()
                        Catch
                        End Try
                    End If
                End If
            Catch
            End Try
        Next
    Next
End Sub
